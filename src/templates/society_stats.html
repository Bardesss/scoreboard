{% extends 'base.html' %}
{% block content %}
<script src="/static/vendor/chartjs/chart.js"></script>
<div class="mdc-card mb-4">
  <div class="mdc-card__content">
    <h2 class="mdc-typography--headline5 mb-4">Statistics for {{ society.name }}</h2>
    
    <div class="mb-4" id="statsForm">
      <div class="row">
        <div class="edit-form-field">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="periodSelect">
              <span id="periodSelectText">All time</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="periodSelectDropdown">
              <div class="single-select-option selected" data-value="all">
                <span>All time</span>
              </div>
              <div class="single-select-option" data-value="year">
                <span>Year</span>
              </div>
              <div class="single-select-option" data-value="month">
                <span>Month</span>
              </div>
              <div class="single-select-option" data-value="week">
                <span>Week</span>
              </div>
              <div class="single-select-option" data-value="day">
                <span>Day</span>
              </div>
            </div>
            <input type="hidden" name="period" id="periodSelectInput" value="all">
          </div>
        </div>
        
        <div class="edit-form-field" id="yearDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="yearSelect">
              <span id="yearSelectText">Select year</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="yearSelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select year</span>
              </div>
              {% for available_year, count in available_years_with_count %}
                <div class="single-select-option" data-value="{{ available_year }}">
                  <span>{{ available_year }} ({{ count }})</span>
                </div>
              {% endfor %}
            </div>
            <input type="hidden" name="year" id="yearSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="monthDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="monthSelect">
              <span id="monthSelectText">Select month</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="monthSelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select month</span>
              </div>
            </div>
            <input type="hidden" name="month" id="monthSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="weekDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="weekSelect">
              <span id="weekSelectText">Select week</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="weekSelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select week</span>
              </div>
            </div>
            <input type="hidden" name="week" id="weekSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="dayDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="daySelect">
              <span id="daySelectText">Select day</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="daySelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select day</span>
              </div>
            </div>
            <input type="hidden" name="day" id="daySelectInput">
          </div>
        </div>
      </div>
    </div>

    <div class="mdc-grid">
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most Wins</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="winsChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, count in most_wins.items()|sort(attribute='1', reverse=True) %}
                {% if count > 0 %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ count }}</span>
                  </td>
                </tr>
                {% endif %}
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% set society_player_count = society.player_ids.split(',')|length %}
      {% if society_player_count > 2 %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Best winratio</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="winratioChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, ratio in win_ratios.items()|sort(attribute='1', reverse=True) %}
                {% if ratio > 0 %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ "%.2f"|format(ratio * 100) }}%</span>
                  </td>
                </tr>
                {% endif %}
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      {% if win_type != 'task' and win_type != 'winner' %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most Points</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="pointsChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, pts in most_points.items()|sort(attribute='1', reverse=True) %}
                {% if pts > 0 %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ pts }}</span>
                  </td>
                </tr>
                {% endif %}
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      {% if win_type == 'task' %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most Won Task</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="tasksChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for tid, count in most_won_task.items()|sort(attribute='1', reverse=True) %}
                {% if count > 0 %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for t in tasks %}{% if t.id == tid %}{{ t.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ count }}</span>
                  </td>
                </tr>
                {% endif %}
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      {% if win_type == 'points' %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Highest points</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="highestPointsChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, pts in highest_points.items()|sort(attribute='1', reverse=True) %}
                {% if pts > 0 %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ pts }}</span>
                  </td>
                </tr>
                {% endif %}
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most popular days</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="daysChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for day, count in most_popular_days.items() %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% if day == 0 %}Monday
                    {% elif day == 1 %}Tuesday
                    {% elif day == 2 %}Wednesday
                    {% elif day == 3 %}Thursday
                    {% elif day == 4 %}Friday
                    {% elif day == 5 %}Saturday
                    {% elif day == 6 %}Sunday
                    {% else %}{{ day }}
                    {% endif %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ count }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Longest win streak</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="streakChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, streak in longest_win_streak.items()|sort(attribute='1', reverse=True) %}
                {% if streak > 0 %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ streak }}</span>
                  </td>
                </tr>
                {% endif %}
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function updateDatepicker() {
  const period = document.getElementById('periodSelectInput').value;
  const yearDiv = document.getElementById('yearDiv');
  const monthDiv = document.getElementById('monthDiv');
  const weekDiv = document.getElementById('weekDiv');
  const dayDiv = document.getElementById('dayDiv');
  
  yearDiv.style.display = 'none';
  monthDiv.style.display = 'none';
  weekDiv.style.display = 'none';
  dayDiv.style.display = 'none';
  
  if (period === 'year') {
    yearDiv.style.display = 'block';
  } else if (period === 'month') {
    yearDiv.style.display = 'block';
    monthDiv.style.display = 'block';
  } else if (period === 'week') {
    yearDiv.style.display = 'block';
    weekDiv.style.display = 'block';
  } else if (period === 'day') {
    yearDiv.style.display = 'block';
    monthDiv.style.display = 'block';
    dayDiv.style.display = 'block';
  }
}

async function updateDropdownData(updateType = 'all') {
  const societyId = {{ society.id }};
  const year = document.getElementById('yearSelectInput').value;
  const month = document.getElementById('monthSelectInput').value;
  
  try {
    const response = await fetch(`/api/societies/${societyId}/dropdown-data?year=${year || ''}&month=${month || ''}`);
    const data = await response.json();
    
    if (updateType === 'all' || updateType === 'period') {
      const yearDropdown = document.getElementById('yearSelectDropdown');
      yearDropdown.innerHTML = '<div class="single-select-option" data-value=""><span>Select year</span></div>';
      data.years.forEach(item => {
        const option = document.createElement('div');
        option.className = 'single-select-option';
        option.dataset.value = item.value;
        option.innerHTML = `<span>${item.text}</span>`;
        yearDropdown.appendChild(option);
      });
      initializeSingleSelect('yearSelect', 'yearSelectDropdown', 'yearSelectText', 'yearSelectInput');
    }
    
    if (updateType === 'all' || updateType === 'year' || updateType === 'period') {
      const monthDropdown = document.getElementById('monthSelectDropdown');
      monthDropdown.innerHTML = '<div class="single-select-option" data-value=""><span>Select month</span></div>';
      data.months.forEach(item => {
        const option = document.createElement('div');
        option.className = 'single-select-option';
        option.dataset.value = item.value;
        option.innerHTML = `<span>${item.text}</span>`;
        monthDropdown.appendChild(option);
      });
      initializeSingleSelect('monthSelect', 'monthSelectDropdown', 'monthSelectText', 'monthSelectInput');
    }
    
    if (updateType === 'all' || updateType === 'year' || updateType === 'period') {
      const weekDropdown = document.getElementById('weekSelectDropdown');
      weekDropdown.innerHTML = '<div class="single-select-option" data-value=""><span>Select week</span></div>';
      data.weeks.forEach(item => {
        const option = document.createElement('div');
        option.className = 'single-select-option';
        option.dataset.value = item.value;
        option.innerHTML = `<span>${item.text}</span>`;
        weekDropdown.appendChild(option);
      });
      initializeSingleSelect('weekSelect', 'weekSelectDropdown', 'weekSelectText', 'weekSelectInput');
    }
    
    if (updateType === 'all' || updateType === 'year' || updateType === 'month' || updateType === 'period') {
      const dayDropdown = document.getElementById('daySelectDropdown');
      dayDropdown.innerHTML = '<div class="single-select-option" data-value=""><span>Select day</span></div>';
      data.days.forEach(item => {
        const option = document.createElement('div');
        option.className = 'single-select-option';
        option.dataset.value = item.value;
        option.innerHTML = `<span>${item.text}</span>`;
        dayDropdown.appendChild(option);
      });
      initializeSingleSelect('daySelect', 'daySelectDropdown', 'daySelectText', 'daySelectInput');
    }
  } catch (error) {
    console.error('Error updating dropdown data:', error);
  }
}

function initializeSingleSelect(selectId, dropdownId, textId, inputId) {
  const select = document.getElementById(selectId);
  const dropdown = document.getElementById(dropdownId);
  const textElement = document.getElementById(textId);
  const inputElement = document.getElementById(inputId);
  const container = select.parentElement;
  const options = dropdown.querySelectorAll('.single-select-option');
  
  if (!select) return;
  
  select.onclick = function(e) {
    e.preventDefault();
    container.classList.toggle('active');
  };
  
  options.forEach(option => {
    option.onclick = function() {
      const value = this.dataset.value;
      const text = this.querySelector('span').textContent;
      
      inputElement.value = value;
      textElement.textContent = text;
      
      options.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');
      container.classList.remove('active');
      
      if (inputId === 'periodSelectInput') {
        updateDatepicker();
        if (value !== 'all') {
          updateDropdownData('period');
        } else {
          updateStatsViaAjax();
        }
      } else if (inputId === 'yearSelectInput') {
        updateDropdownData('year');
        updateStatsViaAjax();
      } else if (inputId === 'monthSelectInput') {
        updateDropdownData('month');
        updateStatsViaAjax();
      } else if (inputId === 'weekSelectInput') {
        updateStatsViaAjax();
      } else if (inputId === 'daySelectInput') {
        updateStatsViaAjax();
      }
    };
  });
}

async function updateStatsViaAjax() {
  const params = new URLSearchParams();
  
  const period = document.getElementById('periodSelectInput').value;
  const year = document.getElementById('yearSelectInput').value;
  const month = document.getElementById('monthSelectInput').value;
  const week = document.getElementById('weekSelectInput').value;
  const day = document.getElementById('daySelectInput').value;
  
  console.log('Updating stats with:', { period, year, month, week, day });
  
  if (period) params.append('period', period);
  if (year) params.append('year', year);
  if (month) params.append('month', month);
  if (week) params.append('week', week);
  if (day) params.append('day', day);
  
  const url = `/api/societies/{{ society.id }}/stats?${params.toString()}`;
  console.log('Fetching from URL:', url);
  
  try {
    const response = await fetch(url);
    console.log('Response status:', response.status);
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Received data:', data);
    
    updateStatsDisplay(data);
  } catch (error) {
    console.error('Error updating stats:', error);
  }
}

function updateStatsDisplay(data) {
  console.log('Updating stats display with data:', data);
  
  const chartInstances = [
    'winsChartInstance',
    'winratioChartInstance', 
    'pointsChartInstance',
    'tasksChartInstance',
    'highestPointsChartInstance',
    'daysChartInstance',
    'streakChartInstance'
  ];
  
  chartInstances.forEach(instanceName => {
    if (window[instanceName]) {
      try {
        window[instanceName].destroy();
      } catch (e) {
        console.log(`Error destroying ${instanceName}:`, e);
      }
      window[instanceName] = null;
    }
  });
  
  Chart.helpers.each(Chart.instances, function(instance) {
    try {
      instance.destroy();
    } catch (e) {
      console.log('Error destroying chart instance:', e);
    }
  });
  
  const canvasElements = document.querySelectorAll('canvas');
  canvasElements.forEach(canvas => {
    try {
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    } catch (e) {
      console.log('Error clearing canvas:', e);
    }
  });
  
  if (data.most_wins) {
    const winsChart = document.getElementById('winsChart');
    if (winsChart) {
      const ctx = winsChart.getContext('2d');
      window.winsChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.most_wins.labels,
          datasets: [{
            data: data.most_wins.data,
            backgroundColor: data.most_wins.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }
    
    const winsTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Most Wins'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Wins table element:', winsTable);
    console.log('Most wins data:', data.most_wins);
    if (winsTable) {
      winsTable.innerHTML = '';
      if (data.most_wins && data.most_wins.labels && data.most_wins.labels.length > 0) {
        data.most_wins.labels.forEach((label, index) => {
          const count = data.most_wins.data[index];
          if (count > 0) {
            const row = document.createElement('tr');
            row.className = 'mdc-data-table__row';
            row.innerHTML = `
              <td class="mdc-data-table__cell">${label}</td>
              <td class="mdc-data-table__cell text-right">
                <span class="mdc-chip">${count}</span>
              </td>
            `;
            winsTable.appendChild(row);
          }
        });
        if (winsTable.children.length === 0) {
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
          winsTable.appendChild(row);
        }
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        winsTable.appendChild(row);
      }
    } else {
      console.log('Wins table not found!');
    }
  }
  
  if (data.win_ratios && data.society_player_count > 2) {
    const winratioChart = document.getElementById('winratioChart');
    if (winratioChart) {
      const ctx = winratioChart.getContext('2d');
      window.winratioChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.win_ratios.labels,
          datasets: [{
            data: data.win_ratios.data,
            backgroundColor: data.win_ratios.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw.toFixed(2)}%`;
                }
              }
            }
          }
        }
      });
    }
    
    const winratioTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Best winratio'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Winratio table element:', winratioTable);
    console.log('Win ratios data:', data.win_ratios);
    if (winratioTable) {
      winratioTable.innerHTML = '';
      if (data.win_ratios && data.win_ratios.labels && data.win_ratios.labels.length > 0) {
        data.win_ratios.labels.forEach((label, index) => {
          const ratio = data.win_ratios.data[index];
          if (ratio > 0) {
            const row = document.createElement('tr');
            row.className = 'mdc-data-table__row';
            row.innerHTML = `
              <td class="mdc-data-table__cell">${label}</td>
              <td class="mdc-data-table__cell text-right">
                <span class="mdc-chip">${ratio.toFixed(2)}%</span>
              </td>
            `;
            winratioTable.appendChild(row);
          }
        });
        if (winratioTable.children.length === 0) {
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
          winratioTable.appendChild(row);
        }
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        winratioTable.appendChild(row);
      }
    } else {
      console.log('Winratio table not found!');
    }
  }
  
  if (data.most_points && data.win_type !== 'task' && data.win_type !== 'winner') {
    const pointsChart = document.getElementById('pointsChart');
    if (pointsChart) {
      const ctx = pointsChart.getContext('2d');
      window.pointsChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.most_points.labels,
          datasets: [{
            data: data.most_points.data,
            backgroundColor: data.most_points.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }
    
    const pointsTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Most Points'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Points table element:', pointsTable);
    console.log('Most points data:', data.most_points);
    if (pointsTable) {
      pointsTable.innerHTML = '';
      if (data.most_points && data.most_points.labels && data.most_points.labels.length > 0) {
        data.most_points.labels.forEach((label, index) => {
          const points = data.most_points.data[index];
          if (points > 0) {
            const row = document.createElement('tr');
            row.className = 'mdc-data-table__row';
            row.innerHTML = `
              <td class="mdc-data-table__cell">${label}</td>
              <td class="mdc-data-table__cell text-right">
                <span class="mdc-chip">${points}</span>
              </td>
            `;
            pointsTable.appendChild(row);
          }
        });
        if (pointsTable.children.length === 0) {
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
          pointsTable.appendChild(row);
        }
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        pointsTable.appendChild(row);
      }
    } else {
      console.log('Points table not found!');
    }
  }
  
  if (data.most_won_task && data.win_type === 'task') {
    const tasksChart = document.getElementById('tasksChart');
    if (tasksChart) {
      const ctx = tasksChart.getContext('2d');
      window.tasksChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.most_won_task.labels,
          datasets: [{
            data: data.most_won_task.data,
            backgroundColor: data.most_won_task.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }
    
    const tasksTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Most Won Task'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Tasks table element:', tasksTable);
    console.log('Most won task data:', data.most_won_task);
    if (tasksTable) {
      tasksTable.innerHTML = '';
      if (data.most_won_task && data.most_won_task.labels && data.most_won_task.labels.length > 0) {
        data.most_won_task.labels.forEach((label, index) => {
          const count = data.most_won_task.data[index];
          if (count > 0) {
            const row = document.createElement('tr');
            row.className = 'mdc-data-table__row';
            row.innerHTML = `
              <td class="mdc-data-table__cell">${label}</td>
              <td class="mdc-data-table__cell text-right">
                <span class="mdc-chip">${count}</span>
              </td>
            `;
            tasksTable.appendChild(row);
          }
        });
        if (tasksTable.children.length === 0) {
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
          tasksTable.appendChild(row);
        }
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        tasksTable.appendChild(row);
      }
    } else {
      console.log('Tasks table not found!');
    }
  }
  
  if (data.highest_points && data.win_type === 'points') {
    const highestPointsChart = document.getElementById('highestPointsChart');
    if (highestPointsChart) {
      const ctx = highestPointsChart.getContext('2d');
      window.highestPointsChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.highest_points.labels,
          datasets: [{
            data: data.highest_points.data,
            backgroundColor: data.highest_points.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }
    
    const highestPointsTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Highest points'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Highest points table element:', highestPointsTable);
    console.log('Highest points data:', data.highest_points);
    if (highestPointsTable) {
      highestPointsTable.innerHTML = '';
      if (data.highest_points && data.highest_points.labels && data.highest_points.labels.length > 0) {
        data.highest_points.labels.forEach((label, index) => {
          const points = data.highest_points.data[index];
          if (points > 0) {
            const row = document.createElement('tr');
            row.className = 'mdc-data-table__row';
            row.innerHTML = `
              <td class="mdc-data-table__cell">${label}</td>
              <td class="mdc-data-table__cell text-right">
                <span class="mdc-chip">${points}</span>
              </td>
            `;
            highestPointsTable.appendChild(row);
          }
        });
        if (highestPointsTable.children.length === 0) {
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
          highestPointsTable.appendChild(row);
        }
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        highestPointsTable.appendChild(row);
      }
    } else {
      console.log('Highest points table not found!');
    }
  }
  
  if (data.most_popular_days) {
    const daysChart = document.getElementById('daysChart');
    if (daysChart) {
      const ctx = daysChart.getContext('2d');
      window.daysChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.most_popular_days.labels,
          datasets: [{
            data: data.most_popular_days.data,
            backgroundColor: data.most_popular_days.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }
    
    const daysTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Most popular days'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Days table element:', daysTable);
    console.log('Most popular days data:', data.most_popular_days);
    if (daysTable) {
      daysTable.innerHTML = '';
      if (data.most_popular_days && data.most_popular_days.labels && data.most_popular_days.labels.length > 0) {
        data.most_popular_days.labels.forEach((label, index) => {
          const count = data.most_popular_days.data[index];
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = `
            <td class="mdc-data-table__cell">${label}</td>
            <td class="mdc-data-table__cell text-right">
              <span class="mdc-chip">${count}</span>
            </td>
          `;
          daysTable.appendChild(row);
        });
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        daysTable.appendChild(row);
      }
    } else {
      console.log('Days table not found!');
    }
  }
  
  if (data.longest_win_streak) {
    const streakChart = document.getElementById('streakChart');
    if (streakChart) {
      const ctx = streakChart.getContext('2d');
      window.streakChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: data.longest_win_streak.labels,
          datasets: [{
            data: data.longest_win_streak.data,
            backgroundColor: data.longest_win_streak.colors
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: ${context.raw}`;
                }
              }
            }
          }
        }
      });
    }
    
    const streakTable = Array.from(document.querySelectorAll('h4')).find(h4 => h4.textContent.includes('Longest win streak'))?.closest('.mdc-card')?.querySelector('.mdc-data-table__content');
    console.log('Streak table element:', streakTable);
    console.log('Longest win streak data:', data.longest_win_streak);
    if (streakTable) {
      streakTable.innerHTML = '';
      if (data.longest_win_streak && data.longest_win_streak.labels && data.longest_win_streak.labels.length > 0) {
        data.longest_win_streak.labels.forEach((label, index) => {
          const streak = data.longest_win_streak.data[index];
          if (streak > 0) {
            const row = document.createElement('tr');
            row.className = 'mdc-data-table__row';
            row.innerHTML = `
              <td class="mdc-data-table__cell">${label}</td>
              <td class="mdc-data-table__cell text-right">
                <span class="mdc-chip">${streak}</span>
              </td>
            `;
            streakTable.appendChild(row);
          }
        });
        if (streakTable.children.length === 0) {
          const row = document.createElement('tr');
          row.className = 'mdc-data-table__row';
          row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
          streakTable.appendChild(row);
        }
      } else {
        const row = document.createElement('tr');
        row.className = 'mdc-data-table__row';
        row.innerHTML = '<td class="mdc-data-table__cell">No data</td>';
        streakTable.appendChild(row);
      }
    } else {
      console.log('Streak table not found!');
    }
  }
  
  setTimeout(initMasonry, 100);
}

function generatePastelColors(count) {
  const colors = [];
  for (let i = 0; i < count; i++) {
    const hue = (i * 137.5) % 360;
    colors.push(`hsl(${hue}, 70%, 80%)`);
  }
  return colors;
}

function createPieChart(canvasId, data, labels, colors) {
  new Chart(document.getElementById(canvasId), {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

function initMasonry() {
  const grid = document.querySelector('.mdc-grid');
  if (!grid) return;
  
  const cards = grid.querySelectorAll('.mdc-card');
  const isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    cards.forEach(card => {
      card.style.position = 'static';
      card.style.top = 'auto';
      card.style.left = 'auto';
      card.style.width = '100%';
    });
    grid.style.height = 'auto';
    grid.style.position = 'static';
    return;
  }
  
  const columns = 3;
  const gaps = 24;
  
  cards.forEach(card => {
    card.style.position = 'static';
    card.style.top = 'auto';
    card.style.left = 'auto';
  });
  
  const columnHeights = new Array(columns).fill(0);
  
  cards.forEach(card => {
    const shortestColumn = columnHeights.indexOf(Math.min(...columnHeights));
    
    card.style.position = 'absolute';
    card.style.top = columnHeights[shortestColumn] + 'px';
    card.style.left = (shortestColumn * (100 / columns)) + '%';
    card.style.width = 'calc(' + (100 / columns) + '% - ' + (gaps * (columns - 1) / columns) + 'px)';
    
    columnHeights[shortestColumn] += card.offsetHeight + gaps;
  });
  
  grid.style.height = Math.max(...columnHeights) + 'px';
  grid.style.position = 'relative';
}

document.addEventListener('DOMContentLoaded', function() {
  updateDatepicker();
  initializeSingleSelect('periodSelect', 'periodSelectDropdown', 'periodSelectText', 'periodSelectInput');
  initializeSingleSelect('yearSelect', 'yearSelectDropdown', 'yearSelectText', 'yearSelectInput');
  initializeSingleSelect('monthSelect', 'monthSelectDropdown', 'monthSelectText', 'monthSelectInput');
  initializeSingleSelect('weekSelect', 'weekSelectDropdown', 'weekSelectText', 'weekSelectInput');
  initializeSingleSelect('daySelect', 'daySelectDropdown', 'daySelectText', 'daySelectInput');
  
  setTimeout(initMasonry, 100);
});

document.addEventListener('click', function(e) {
  const dropdowns = document.querySelectorAll('.custom-single-select');
  dropdowns.forEach(dropdown => {
    if (!dropdown.contains(e.target)) {
      dropdown.classList.remove('active');
    }
  });
});

window.addEventListener('resize', function() {
  setTimeout(initMasonry, 100);
});

const winsData = {
  labels: {{ most_wins_json | tojson }},
  data: {{ most_wins_data_json | tojson }},
  colors: {{ most_wins_colors_json | tojson }}
};

createPieChart('winsChart', winsData.data, winsData.labels, winsData.colors);

{% if society_player_count > 2 %}
const winratioData = {
  labels: {{ win_ratios_json | tojson }},
  data: {{ win_ratios_data_json | tojson }},
  colors: {{ win_ratios_colors_json | tojson }}
};

createPieChart('winratioChart', winratioData.data, winratioData.labels, winratioData.colors);
{% endif %}

{% if win_type != 'task' and win_type != 'winner' %}
const pointsData = {
  labels: {{ most_points_json | tojson }},
  data: {{ most_points_data_json | tojson }},
  colors: {{ most_points_colors_json | tojson }}
};

createPieChart('pointsChart', pointsData.data, pointsData.labels, pointsData.colors);
{% endif %}

{% if win_type == 'task' %}
const tasksData = {
  labels: {{ most_won_task_json | tojson }},
  data: {{ most_won_task_data_json | tojson }},
  colors: generatePastelColors({{ most_won_task|length }})
};

createPieChart('tasksChart', tasksData.data, tasksData.labels, tasksData.colors);
{% endif %}

{% if win_type == 'points' %}
const highestPointsData = {
  labels: {{ highest_points_json | tojson }},
  data: {{ highest_points_data_json | tojson }},
  colors: {{ highest_points_colors_json | tojson }}
};

createPieChart('highestPointsChart', highestPointsData.data, highestPointsData.labels, highestPointsData.colors);
{% endif %}

const daysData = {
  labels: {{ most_popular_days_json | tojson }},
  data: {{ most_popular_days_data_json | tojson }},
  colors: generatePastelColors({{ most_popular_days|length }})
};

createPieChart('daysChart', daysData.data, daysData.labels, daysData.colors);

const streakData = {
  labels: {{ longest_win_streak_json | tojson }},
  data: {{ longest_win_streak_data_json | tojson }},
  colors: {{ longest_win_streak_colors_json | tojson }}
};

createPieChart('streakChart', streakData.data, streakData.labels, streakData.colors);
</script>
{% endblock %} 
