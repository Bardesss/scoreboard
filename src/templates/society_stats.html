{% extends 'base.html' %}
{% block content %}
<script src="/static/vendor/chartjs/chart.js"></script>
<div class="mdc-card mb-4">
  <div class="mdc-card__content">
    <h2 class="mdc-typography--headline5 mb-4">Statistics for {{ society.name }}</h2>
    
    <div class="mb-4" id="statsForm">
      <div class="row">
        <div class="edit-form-field">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="periodSelect">
              <span id="periodSelectText">Select period</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="periodSelectDropdown">
              <div class="single-select-option" data-value="all" {% if period == 'all' %}data-selected="true"{% endif %}>
                <span>All time</span>
              </div>
              <div class="single-select-option" data-value="year" {% if period == 'year' %}data-selected="true"{% endif %}>
                <span>Year</span>
              </div>
              <div class="single-select-option" data-value="month" {% if period == 'month' %}data-selected="true"{% endif %}>
                <span>Month</span>
              </div>
              <div class="single-select-option" data-value="week" {% if period == 'week' %}data-selected="true"{% endif %}>
                <span>Week</span>
              </div>
              <div class="single-select-option" data-value="day" {% if period == 'day' %}data-selected="true"{% endif %}>
                <span>Day</span>
              </div>
            </div>
            <input type="hidden" name="period" id="periodSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="yearDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="yearSelect">
              <span id="yearSelectText">Select year</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="yearSelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select year</span>
              </div>
              {% for available_year, count in available_years_with_count %}
                <div class="single-select-option" data-value="{{ available_year }}" {% if year and available_year|string == year %}data-selected="true"{% endif %}>
                  <span>{{ available_year }} ({{ count }})</span>
                </div>
              {% endfor %}
            </div>
            <input type="hidden" name="year" id="yearSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="monthDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="monthSelect">
              <span id="monthSelectText">Select month</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="monthSelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select month</span>
              </div>
              {% for available_year, available_month, count in available_months_with_count %}
              {% set month_names = {1: "January", 2: "February", 3: "March", 4: "April", 5: "May", 6: "June", 7: "July", 8: "August", 9: "September", 10: "October", 11: "November", 12: "December"} %}
                <div class="single-select-option" data-value="{{ available_month }}" {% if month and available_month|string == month and year and available_year|string == year %}data-selected="true"{% endif %}>
                  <span>{{ month_names[available_month] }} ({{ count }})</span>
                </div>
              {% endfor %}
            </div>
            <input type="hidden" name="month" id="monthSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="weekDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="weekSelect">
              <span id="weekSelectText">Select week</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="weekSelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select week</span>
              </div>
              {% for available_year, available_week, count in available_weeks_with_count %}
                <div class="single-select-option" data-value="{{ available_week }}" {% if week and available_week|string == week and year and available_year|string == year %}data-selected="true"{% endif %}>
                  <span>Week {{ available_week }} ({{ count }})</span>
                </div>
              {% endfor %}
            </div>
            <input type="hidden" name="week" id="weekSelectInput">
          </div>
        </div>
        
        <div class="edit-form-field" id="dayDiv" style="display: none;">
          <div class="custom-single-select">
            <div class="single-select-trigger" id="daySelect">
              <span id="daySelectText">Select day</span>
              <div class="single-select-arrow">▼</div>
            </div>
            <div class="single-select-dropdown" id="daySelectDropdown">
              <div class="single-select-option" data-value="">
                <span>Select day</span>
              </div>
              {% for available_year, available_month, available_day, available_weekday, count in available_days_with_count %}
                <div class="single-select-option" data-value="{{ available_day }}" {% if day and available_day|string == day and month and available_month|string == month and year and available_year|string == year %}data-selected="true"{% endif %}>
                  <span>{{ available_day }} - {{ available_weekday }} ({{ count }})</span>
                </div>
              {% endfor %}
            </div>
            <input type="hidden" name="day" id="daySelectInput">
          </div>
        </div>
      </div>
    </div>

    <div class="mdc-grid">
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most Wins</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="winsChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, count in most_wins.items()|sort(attribute='1', reverse=True) %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ count }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% set society_player_count = society.player_ids.split(',')|length %}
      {% if society_player_count > 2 %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Best winratio</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="winratioChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, ratio in win_ratios.items()|sort(attribute='1', reverse=True) %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ "%.2f"|format(ratio * 100) }}%</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      {% if win_type != 'task' and win_type != 'winner' %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most Points</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="pointsChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, pts in most_points.items()|sort(attribute='1', reverse=True) %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ pts }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      {% if win_type != 'points' and win_type != 'winner' %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most Won Task</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="tasksChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for tid, count in most_won_task.items()|sort(attribute='1', reverse=True) %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for t in tasks %}{% if t.id == tid %}{{ t.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ count }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      {% if win_type == 'points' %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Highest points</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="highestPointsChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, pts in highest_points.items()|sort(attribute='1', reverse=True) %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ pts }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Most popular days</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="daysChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% set weekdays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                {% for day, count in most_popular_days.items() %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">{{ weekdays[day] }}</td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ count }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="mdc-card">
        <div class="mdc-card__content">
          <h4 class="mdc-typography--headline6 mb-3">Longest win streak</h4>
          <div class="mx-auto" style="max-width: 50%;">
            <canvas id="streakChart" class="mb-3"></canvas>
          </div>
          <div class="mdc-data-table">
            <table class="mdc-data-table__table">
              <tbody class="mdc-data-table__content">
                {% for pid, streak in longest_win_streak.items()|sort(attribute='1', reverse=True) %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">
                    {% for p in players %}{% if p.id == pid %}{{ p.name }}{% endif %}{% endfor %}
                  </td>
                  <td class="mdc-data-table__cell text-right">
                    <span class="mdc-chip">{{ streak }}</span>
                  </td>
                </tr>
                {% else %}
                <tr class="mdc-data-table__row">
                  <td class="mdc-data-table__cell">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Datepicker functionaliteit
function updateDatepicker() {
  const period = document.getElementById('period').value;
  const yearDiv = document.getElementById('yearDiv');
  const monthDiv = document.getElementById('monthDiv');
  const weekDiv = document.getElementById('weekDiv');
  const dayDiv = document.getElementById('dayDiv');
  
  // Verberg alle dropdowns
  yearDiv.style.display = 'none';
  monthDiv.style.display = 'none';
  weekDiv.style.display = 'none';
  dayDiv.style.display = 'none';
  
  // Toon relevante dropdowns op basis van periode
  if (period === 'year') {
    yearDiv.style.display = 'block';
  } else if (period === 'month') {
    yearDiv.style.display = 'block';
    monthDiv.style.display = 'block';
  } else if (period === 'week') {
    yearDiv.style.display = 'block';
    weekDiv.style.display = 'block';
  } else if (period === 'day') {
    yearDiv.style.display = 'block';
    monthDiv.style.display = 'block';
    dayDiv.style.display = 'block';
  }
}

// AJAX functie voor het ophalen van dropdown data
async function updateDropdownData(updateType = 'all') {
  const societyId = {{ society.id }};
  const year = document.getElementById('year').value;
  const month = document.getElementById('month').value;
  
  try {
    const response = await fetch(`/api/societies/${societyId}/dropdown-data?year=${year || ''}&month=${month || ''}`);
    const data = await response.json();
    
    // Update year dropdown alleen als het een periode change is
    if (updateType === 'all' || updateType === 'period') {
      const yearSelect = document.getElementById('year');
      const currentYear = yearSelect.value;
      yearSelect.innerHTML = '<option value=""></option>';
      data.years.forEach(item => {
        const option = document.createElement('option');
        option.value = item.value;
        option.textContent = item.text;
        if (item.value == currentYear) {
          option.selected = true;
        }
        yearSelect.appendChild(option);
      });
    }
    
    // Update month dropdown
    const monthSelect = document.getElementById('month');
    const currentMonth = monthSelect.value;
    monthSelect.innerHTML = '<option value=""></option>';
    data.months.forEach(item => {
      const option = document.createElement('option');
      option.value = item.value;
      option.textContent = item.text;
      if (item.value == currentMonth) {
        option.selected = true;
      }
      monthSelect.appendChild(option);
    });
    
    // Update week dropdown
    const weekSelect = document.getElementById('week');
    const currentWeek = weekSelect.value;
    weekSelect.innerHTML = '<option value=""></option>';
    data.weeks.forEach(item => {
      const option = document.createElement('option');
      option.value = item.value;
      option.textContent = item.text;
      if (item.value == currentWeek) {
        option.selected = true;
      }
      weekSelect.appendChild(option);
    });
    
    // Update day dropdown
    const daySelect = document.getElementById('day');
    const currentDay = daySelect.value;
    daySelect.innerHTML = '<option value=""></option>';
    data.days.forEach(item => {
      const option = document.createElement('option');
      option.value = item.value;
      option.textContent = item.text;
      if (item.value == currentDay) {
        option.selected = true;
      }
      daySelect.appendChild(option);
    });
  } catch (error) {
    console.error('Error updating dropdown data:', error);
  }
}

// Functie om te controleren of alle benodigde dropdowns zijn ingevuld
function checkRequiredFields() {
  const period = document.getElementById('period').value;
  const year = document.getElementById('year').value;
  const month = document.getElementById('month').value;
  const week = document.getElementById('week').value;
  const day = document.getElementById('day').value;
  
  // Controleer of alle benodigde velden zijn ingevuld
  if (period === 'all') {
    return true; // Voor 'all' zijn geen extra velden nodig
  } else if (period === 'year' && year) {
    return true;
  } else if (period === 'month' && year && month) {
    return true;
  } else if (period === 'week' && year && week) {
    return true;
  } else if (period === 'day' && year && month && day) {
    return true;
  }
  
  return false;
}

// Functie om automatisch de pagina te herladen met nieuwe parameters
function autoUpdateStats() {
  if (checkRequiredFields()) {
    const params = new URLSearchParams();
    
    // Haal alle dropdown waarden op
    const period = document.getElementById('period').value;
    const year = document.getElementById('year').value;
    const month = document.getElementById('month').value;
    const week = document.getElementById('week').value;
    const day = document.getElementById('day').value;
    
    // Voeg alle waarden toe aan URL parameters
    if (period) params.append('period', period);
    if (year) params.append('year', year);
    if (month) params.append('month', month);
    if (week) params.append('week', week);
    if (day) params.append('day', day);
    
    // Navigeer naar de nieuwe URL
    window.location.href = window.location.pathname + '?' + params.toString();
  }
}


document.addEventListener('DOMContentLoaded', function() {
  // Initialiseer datepicker bij het laden van de pagina
  updateDatepicker();
  
  // Voeg event listeners toe aan de dropdowns
  document.getElementById('period').addEventListener('change', function() {
    const currentPeriod = this.value;
    const yearSelect = document.getElementById('year');
    const monthSelect = document.getElementById('month');
    const weekSelect = document.getElementById('week');
    const daySelect = document.getElementById('day');
    
    // Behoud relevante waarden op basis van nieuwe periode
    if (currentPeriod === 'all') {
      // Reset alles voor 'all'
      yearSelect.value = '';
      monthSelect.value = '';
      weekSelect.value = '';
      daySelect.value = '';
    } else if (currentPeriod === 'year') {
      // Behoud year, reset de rest
      monthSelect.value = '';
      weekSelect.value = '';
      daySelect.value = '';
    } else if (currentPeriod === 'month') {
      // Behoud year, reset de rest
      weekSelect.value = '';
      daySelect.value = '';
    } else if (currentPeriod === 'week') {
      // Behoud year, reset de rest
      monthSelect.value = '';
      daySelect.value = '';
    } else if (currentPeriod === 'day') {
      // Behoud year en month, reset day
      weekSelect.value = '';
    }
    
    updateDatepicker();
    if (this.value !== 'all') {
      updateDropdownData('period');
    } else {
      // Voor 'all' direct updaten
      autoUpdateStats();
    }
  });
  
  document.getElementById('year').addEventListener('change', function() {
    updateDatepicker();
    updateDropdownData('year');
    autoUpdateStats();
  });
  
  document.getElementById('month').addEventListener('change', function() {
    updateDatepicker();
    updateDropdownData('month');
    autoUpdateStats();
  });
  
  document.getElementById('week').addEventListener('change', function() {
    updateDatepicker();
    autoUpdateStats();
  });
  
  document.getElementById('day').addEventListener('change', function() {
    updateDatepicker();
    autoUpdateStats();
  });
});

function generatePastelColors(count) {
  const colors = [];
  for (let i = 0; i < count; i++) {
    const hue = (i * 137.5) % 360;
    colors.push(`hsl(${hue}, 70%, 80%)`);
  }
  return colors;
}

function createPieChart(canvasId, data, labels, colors) {
  new Chart(document.getElementById(canvasId), {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.raw}`;
            }
          }
        }
      }
    }
  });
}

// Charts data
const winsData = {
  labels: {{ most_wins_json | tojson }},
  data: {{ most_wins_data_json | tojson }},
  colors: {{ most_wins_colors_json | tojson }}
};

createPieChart('winsChart', winsData.data, winsData.labels, winsData.colors);

{% if society_player_count > 2 %}
const winratioData = {
  labels: {{ win_ratios_json | tojson }},
  data: {{ win_ratios_data_json | tojson }},
  colors: {{ win_ratios_colors_json | tojson }}
};

createPieChart('winratioChart', winratioData.data, winratioData.labels, winratioData.colors);
{% endif %}

{% if win_type != 'task' and win_type != 'winner' %}
const pointsData = {
  labels: {{ most_points_json | tojson }},
  data: {{ most_points_data_json | tojson }},
  colors: {{ most_points_colors_json | tojson }}
};

createPieChart('pointsChart', pointsData.data, pointsData.labels, pointsData.colors);
{% endif %}

{% if win_type != 'points' and win_type != 'winner' %}
const tasksData = {
  labels: {{ most_won_task_json | tojson }},
  data: {{ most_won_task_data_json | tojson }},
  colors: generatePastelColors({{ most_won_task|length }})
};

createPieChart('tasksChart', tasksData.data, tasksData.labels, tasksData.colors);
{% endif %}

{% if win_type == 'points' %}
const highestPointsData = {
  labels: {{ highest_points_json | tojson }},
  data: {{ highest_points_data_json | tojson }},
  colors: {{ highest_points_colors_json | tojson }}
};

createPieChart('highestPointsChart', highestPointsData.data, highestPointsData.labels, highestPointsData.colors);
{% endif %}

const daysData = {
  labels: {{ most_popular_days_json | tojson }},
  data: {{ most_popular_days_data_json | tojson }},
  colors: generatePastelColors({{ most_popular_days|length }})
};

createPieChart('daysChart', daysData.data, daysData.labels, daysData.colors);

const streakData = {
  labels: {{ longest_win_streak_json | tojson }},
  data: {{ longest_win_streak_data_json | tojson }},
  colors: {{ longest_win_streak_colors_json | tojson }}
};

createPieChart('streakChart', streakData.data, streakData.labels, streakData.colors);

// Masonry layout voor de grid
function initMasonry() {
  const grid = document.querySelector('.mdc-grid');
  if (!grid) return;
  
  const cards = grid.querySelectorAll('.mdc-card');
  const isMobile = window.innerWidth <= 768;
  
  if (isMobile) {
    // Op mobiel: gewone flexbox layout
    cards.forEach(card => {
      card.style.position = 'static';
      card.style.top = 'auto';
      card.style.left = 'auto';
      card.style.width = '100%';
    });
    grid.style.height = 'auto';
    grid.style.position = 'static';
    return;
  }
  
  // Desktop: masonry layout
  const columns = 3;
  const gaps = 24;
  
  // Reset heights
  cards.forEach(card => {
    card.style.position = 'static';
    card.style.top = 'auto';
    card.style.left = 'auto';
  });
  
  // Calculate column heights
  const columnHeights = new Array(columns).fill(0);
  
  cards.forEach(card => {
    // Find shortest column
    const shortestColumn = columnHeights.indexOf(Math.min(...columnHeights));
    
    // Position card
    card.style.position = 'absolute';
    card.style.top = columnHeights[shortestColumn] + 'px';
    card.style.left = (shortestColumn * (100 / columns)) + '%';
    card.style.width = 'calc(' + (100 / columns) + '% - ' + (gaps * (columns - 1) / columns) + 'px)';
    
    // Update column height
    columnHeights[shortestColumn] += card.offsetHeight + gaps;
  });
  
  // Set grid height
  grid.style.height = Math.max(...columnHeights) + 'px';
  grid.style.position = 'relative';
}

// Initialize masonry when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Function to initialize custom single select
  function initializeSingleSelect(selectId, dropdownId, textId, inputId) {
    const select = document.getElementById(selectId);
    const dropdown = document.getElementById(dropdownId);
    const textElement = document.getElementById(textId);
    const inputElement = document.getElementById(inputId);
    const container = select.parentElement;
    const options = dropdown.querySelectorAll('.single-select-option');

    if (!select) return; // Element doesn't exist (conditional rendering)

    // Initialize with selected value if exists
    const selectedOption = dropdown.querySelector('[data-selected="true"]');
    if (selectedOption) {
      const value = selectedOption.dataset.value;
      const text = selectedOption.querySelector('span').textContent;
      inputElement.value = value;
      textElement.textContent = text;
      selectedOption.classList.add('selected');
    }

    select.addEventListener('click', function(e) {
      e.preventDefault();
      container.classList.toggle('active');
    });

    // Handle option selection
    options.forEach(option => {
      option.addEventListener('click', function() {
        const value = this.dataset.value;
        const text = this.querySelector('span').textContent;
        
        // Update hidden input
        inputElement.value = value;
        
        // Update display text
        textElement.textContent = text;
        
        // Update selected state
        options.forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        
        // Close dropdown
        container.classList.remove('active');
        
        // Submit form
        this.closest('form').submit();
      });
    });
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const dropdowns = document.querySelectorAll('.custom-single-select');
    dropdowns.forEach(dropdown => {
      if (!dropdown.contains(e.target)) {
        dropdown.classList.remove('active');
      }
    });
  });

  // Initialize all custom single selects
  initializeSingleSelect('periodSelect', 'periodSelectDropdown', 'periodSelectText', 'periodSelectInput');
  initializeSingleSelect('yearSelect', 'yearSelectDropdown', 'yearSelectText', 'yearSelectInput');
  initializeSingleSelect('monthSelect', 'monthSelectDropdown', 'monthSelectText', 'monthSelectInput');
  initializeSingleSelect('weekSelect', 'weekSelectDropdown', 'weekSelectText', 'weekSelectInput');
  initializeSingleSelect('daySelect', 'daySelectDropdown', 'daySelectText', 'daySelectInput');

  setTimeout(initMasonry, 100); // Small delay to ensure charts are rendered
});

// Reinitialize on window resize
window.addEventListener('resize', function() {
  setTimeout(initMasonry, 100);
});
</script>
{% endblock %} 
